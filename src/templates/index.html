<!DOCTYPE html>
<html>
	<head>
		<title>ArtistDL</title>
		<link rel="stylesheet" href="/static/style.css" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Nova+Mono&display=swap" rel="stylesheet" />
	</head>
	<body>
		<div class="container">
			<div class="left-panel">
				<div class="search-box">
					<h2>Search</h2>
					<form action="/" method="post">
						<div class="flex-box">
							<div>
								<label for="artist">Artist Name:</label>
								<input type="text" id="artist" name="artist" required />
							</div>
							<div>
								<label for="limit">Track Limit:</label>
								<input type="number" id="limit" name="limit" value="10" />
							</div>
						</div>
						<button type="submit">Download</button>
					</form>
				</div>
				<div class="progress-box">
					<h2>Current Download</h2>
					<div id="progress">No active downloads.</div>
				</div>
				<div class="queue-box">
					<h2>Download Queue</h2>
					<div id="queue"></div>
				</div>
				<div class="add-multiple-box">
					<button id="add-multiple-btn">Add multiple artists</button>
					<div id="add-multiple-form" style="display: none">
						<form action="/add_multiple" method="post">
							<textarea name="artists" rows="5"></textarea>
							<button type="submit">Submit</button>
						</form>
					</div>
				</div>
			</div>
			<div class="right-panel">
				<h2>Downloaded Songs</h2>
				<table id="downloads-table">
					<thead>
						<tr>
							<th>#</th>
							<th>Track</th>
							<th>Artist</th>
							<th>Downloaded</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
				<div class="pagination">
					<button id="prev-page">Previous</button>
					<span id="page-info"></span>
					<button id="next-page">Next</button>
				</div>
			</div>
		</div>

		<script>
			document.getElementById('add-multiple-btn').addEventListener('click', function () {
				document.getElementById('add-multiple-form').style.display = 'block'
				this.style.display = 'none'
			})

			function updateQueue() {
				fetch('/queue')
					.then((response) => response.json())
					.then((data) => {
						let queueText = ''
						if (data.length > 0) {
							data.forEach((item, index) => {
								if (item.status === 'downloading') {
									queueText += `<div class="queue-item downloading">${item.artist} - ${item.limit} tracks</div>`
								} else {
									queueText += `<div class="queue-item">${item.artist} - ${item.limit} tracks</div>`
								}
							})
						} else {
							queueText = 'Queue is empty.'
						}
						document.getElementById('queue').innerHTML = queueText
					})
			}

			function updateProgress() {
				fetch('/progress')
					.then((response) => response.json())
					.then((data) => {
						let progressText = 'No active downloads.'
						if (data) {
							progressText = `Downloading ${data.artist}: ${data.progress.toFixed(2)}%`
						}
						document.getElementById('progress').textContent = progressText
					})
			}

			let downloadedSongs = []
			let currentPage = 1
			const rowsPerPage = 25

			function renderDownloadsTable() {
				let tableBody = document.querySelector('#downloads-table tbody')
				tableBody.innerHTML = ''
				const start = (currentPage - 1) * rowsPerPage
				const end = start + rowsPerPage
				const paginatedSongs = downloadedSongs.slice(start, end)

				if (paginatedSongs.length > 0) {
					paginatedSongs.forEach((song, index) => {
						let row = `<tr>
							<td>${start + index + 1}</td>
							<td>${song.track}</td>
							<td>${song.artist}</td>
							<td>${song.download_date}</td>
						</tr>`
						tableBody.innerHTML += row
					})
				} else {
					let row = `<tr>
						<td colspan="4">No songs downloaded yet.</td>
					</tr>`
					tableBody.innerHTML = row
				}

				document.getElementById('page-info').textContent = `Page ${currentPage} of ${Math.ceil(downloadedSongs.length / rowsPerPage)}`
				document.getElementById('prev-page').disabled = currentPage === 1
				document.getElementById('next-page').disabled = currentPage === Math.ceil(downloadedSongs.length / rowsPerPage)
			}

			function updateDownloads() {
				fetch('/downloads')
					.then((response) => response.json())
					.then((data) => {
						data.sort((a, b) => new Date(b.download_date) - new Date(a.download_date));
						downloadedSongs = data;
						renderDownloadsTable();
					});
			}

			document.getElementById('prev-page').addEventListener('click', () => {
				if (currentPage > 1) {
					currentPage--
					renderDownloadsTable()
				}
			})

			document.getElementById('next-page').addEventListener('click', () => {
				if (currentPage < Math.ceil(downloadedSongs.length / rowsPerPage)) {
					currentPage++
					renderDownloadsTable()
				}
			})

			setInterval(updateQueue, 1000)
			setInterval(updateProgress, 5000)
			setInterval(updateDownloads, 30000)
			updateQueue()
			updateProgress()
			updateDownloads()
		</script>
	</body>
</html>
